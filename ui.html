<style>
  img {
    display:block;
    margin-left:auto;
    margin-right:auto;
  }

  input {
    position:absolute;
    left:5px;
    bottom:5px;
  }

  button {
    position:absolute;
    right:5px;
    bottom:5px;
  }

  button:disabled {
    background:#CCC;
  }
</style>

<link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">
<img id="img">
<input id="saveAs" type="text" placeholder="Filename">
<a id="dl" download><button>Save Zip</button></a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.3.0/jszip.min.js"></script>
<script>
  onmessage = (event) => {
    const zip = new JSZip()

    const imgId = document.getElementById("img")
    const dlId = document.getElementById("dl")
    const imgArray = event.data.pluginMessage

    for (let i = 1; i < imgArray.length; i++) {
      imgId.src = "data:image/png;base64," + btoa(String.fromCharCode.apply(null, imgArray[i]))
      const canvas = document.createElement("canvas")
      const ctx = canvas.getContext("2d")
      canvas.width = imgId.width
      canvas.height = imgId.height
      ctx.drawImage(imgId, 0, 0)
      imgArray[i] = canvas.toDataURL("image/webp", 1.0)
    }
    imgId.src = "data:image/png;base64," + btoa(String.fromCharCode.apply(null, imgArray[0]))
    
    const saveAs = document.getElementById("saveAs").value

    for(let i = 1; i < imgArray.length; i++) {
      let folderName = "drawable-"
      switch(i) {
        case 1:
          folderName += "mdpi"
          break
        case 2:
          folderName += "hdpi"
          break
        case 3:
          folderName += "xhdpi"
          break
        case 4:
          folderName += "xxhdpi"
          break
        case 5:
          folderName += "xxxhdpi"
          break
      }

      const base64 = imgArray[i].split(",")[1]
      
      if (base64 == "") {
        alert("Generating webp failed, please rerun the plugin.")
        break
      }

      zip.file(${folderName}/${saveAs}.webp, base64, {base64: true})
    }

    zip.generateAsync({type:"base64"}).then((base64) => {
      dlId.href="data:application/zip;base64," + base64
    })
  }
</script>