<style>
  img {
    display:block;
    margin-left:auto;
    margin-right:auto;
  }

  input {
    position:absolute;
    left:5px;
    bottom:5px;
  }

  button {
    position:absolute;
    right:5px;
    bottom:5px;
  }

  button:disabled {
    background:#CCC;
  }
</style>

<link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">
<img id="img">
<input id="saveAs" type="text" placeholder="Filename">
<a id="dl"><button id="btn" disabled="true">Save Zip</button></a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.3.0/jszip.min.js"></script>
<script>
  let imgArray
  const zip = new JSZip()

  const imgId = document.getElementById("img")
  const dlId = document.getElementById("dl")
  const btnId = document.getElementById("btn")

  onmessage = (event) => {
    imgArray = event.data.pluginMessage
    imgId.src = "data:image/png;base64," + btoa(String.fromCharCode.apply(null, imgArray[0]))

    for (let i = 1; i < imgArray.length; i++) {
      const tempImg = new Image()
      tempImg.src = "data:image/png;base64," + btoa(String.fromCharCode.apply(null, imgArray[i]))
      const canvas = document.createElement("canvas")
      const ctx = canvas.getContext("2d")
      canvas.width = tempImg.width
      canvas.height = tempImg.height
      ctx.drawImage(tempImg, 0, 0)
      imgArray[i] = canvas.toDataURL("image/webp", 1.0)
    }
    btnId.disabled = false

    document.querySelector("a").onclick = () => {
      const saveAs = document.getElementById("saveAs").value
      let broken = false

      for(let i = 1; i < imgArray.length; i++) {
        let folderName = "drawable-"
        switch(i) {
          case 1:
            folderName += "mdpi"
            break
          case 2:
            folderName += "hdpi"
            break
          case 3:
            folderName += "xhdpi"
            break
          case 4:
            folderName += "xxhdpi"
            break
          case 5:
            folderName += "xxxhdpi"
            break
        }

        let base64 = imgArray[i].split(",")[1]
        
        if (base64 == "") {
          alert("Generating webp failed, please rerun the plugin.")
          broken = true
          break
        }

        zip.file(${folderName}/${saveAs}.webp, base64, {base64: true})
      }

      if (!broken) {
        zip.generateAsync({type:"base64"}).then((base64) => {
          location.href="data:application/zip;base64," + base64
        })
      }
    }
  }
</script>